{% extends "base.html" %}
{% block titulo %}GestiÃ³n de usuarios{% endblock %}

{% block contenido %}
<div class="container">
  <h1 class="titulo-pagina mt-5">GestiÃ³n de Usuarios</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- ðŸ”§ Botones de acciÃ³n -->
  <div class="acciones-reportes d-flex justify-content-between align-items-end mb-4">
    <div class="d-flex gap-2 align-items-end">
      <button type="button" class="btn-accion" onclick="activarEliminacionUsuarios()" id="btn-eliminar">
        <i class="fa-solid fa-trash"></i>
        <span>Eliminar</span>
      </button>

      <button type="button" class="btn-accion btn-confirmar" id="btn-confirmar-eliminacion" onclick="mostrarModalEliminarUsuarios()">
        <i class="fa-solid fa-circle-check"></i>
        <span>Confirmar eliminaciÃ³n</span>
      </button>
    </div>
  </div>
<div class="tabla-scroll">
  <table class="table-usuarios">
  <thead>
    <tr>
      <th></th>
      <th>IdentificaciÃ³n</th>
      <th>Tipo de identificaciÃ³n</th>
      <th>Nombres</th>
      <th>Apellidos</th>
      <th>Correo</th>
      <th>Tipo de usuario</th>
      <th>Estado</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody>
    {% for usuario in datos %}
      <tr>
        <td>
          {% if not usuario[7] and usuario[8] == 0 %}
            <input type="checkbox" class="checkbox-eliminar" name="usuarios" value="{{ usuario[0] }}" style="display: none;">
          {% endif %}
        </td>
        <td>{{ usuario[1] }}</td>
        <td>{{ usuario[2] }}</td>
        <td>{{ usuario[3] }}</td>
        <td>{{ usuario[4] }}</td>
        <td>{{ usuario[5] }}</td>
        <td>{{ usuario[6] }}</td>
        <td>{{ 'Activo' if usuario[7] else 'Inactivo' }}</td>
        <td>
          <button type="button" class="btn btn-success btn-actualizar" data-bs-toggle="modal" data-bs-target="#modalActualizar{{ usuario[0] }}">
            Actualizar
          </button>

          {% if not usuario[7] and usuario[8] == 0 %}
            <button type="button" class="btn btn-danger btn-sm ms-2"
                    onclick="mostrarModalEliminarUsuario('{{ usuario[0] }}')"
                    title="Eliminar">
              <i class="fa-solid fa-trash"></i>
            </button>
          {% endif %}
        </td>
      </tr>
      {% include 'editar_usuarios.html' %}
    {% endfor %}
  </tbody>
</table>
</div>

  <!-- âœ… Modal de confirmaciÃ³n de eliminaciÃ³n individual -->
  <div id="modal-eliminar-usuario" class="modal-nombrar" style="display: none;">
    <form method="POST" id="form-eliminar-usuario">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <label>Â¿Confirmas eliminar este usuario inactivo sin reportes?</label>
      <div class="botones-modal mt-3">
        <button type="submit" class="btn btn-sm btn-danger">
          <i class="fa-solid fa-circle-check"></i> SÃ­, eliminar
        </button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="cerrarModalEliminarUsuario()">Cancelar</button>
      </div>
    </form>
  </div>

  <!-- âœ… Modal de confirmaciÃ³n de eliminaciÃ³n mÃºltiple -->
  <div id="modal-eliminar-usuarios" class="modal-nombrar" style="display: none;">
    <form method="POST" action="{{ url_for('eliminar_usuarios_multiples') }}" id="form-eliminar-usuarios">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div id="usuarios-seleccionados"></div>
      <label>Â¿Confirmas eliminar los usuarios seleccionados?</label>
      <div class="botones-modal mt-3">
        <button type="submit" class="btn btn-sm btn-danger">
          <i class="fa-solid fa-circle-check"></i> SÃ­, eliminar
        </button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="cerrarModalEliminarUsuarios()">Cancelar</button>
      </div>
    </form>
  </div>

  <!-- âœ… Scripts -->
   
  <script> 
   function activarEliminacionUsuarios() {
    const checkboxes = document.querySelectorAll(".checkbox-eliminar");
    if (checkboxes.length === 0) {
      alert("Solo se puede eliminar si hay al menos un usuario inactivo sin reportes asociados.");
      return;
    }

    checkboxes.forEach(cb => {
      cb.style.display = "inline-block";
    });
   }

    function mostrarModalEliminarUsuarios() {
      const seleccionados = document.querySelectorAll(".checkbox-eliminar:checked");
      if (seleccionados.length === 0) {
        alert("Selecciona al menos un usuario para eliminar.");
        return;
      }

      const contenedor = document.getElementById("usuarios-seleccionados");
      contenedor.innerHTML = "";

      seleccionados.forEach(cb => {
        const input = document.createElement("input");
        input.type = "hidden";
        input.name = "usuarios";
        input.value = cb.value;
        contenedor.appendChild(input);
      });

      document.getElementById("modal-eliminar-usuarios").style.display = "block";
    }

    function cerrarModalEliminarUsuarios() {
      document.getElementById("modal-eliminar-usuarios").style.display = "none";
    }

    function mostrarModalEliminarUsuario(id) {
      const form = document.getElementById("form-eliminar-usuario");
      form.action = `/Inforise/admin/eliminar_usuario/${id}`;
      document.getElementById("modal-eliminar-usuario").style.display = "block";
    }

    function cerrarModalEliminarUsuario() {
      document.getElementById("modal-eliminar-usuario").style.display = "none";
    }
  </script>
</div>
{% endblock %}