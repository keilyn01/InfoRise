{% extends "base.html" %}
{% block titulo %}Revisiones{% endblock %}

{% block contenido %}
<div class="container contenedor-reportes">
  <h1 class="titulo-pagina mt-5">Revisi√≥n de Reportes</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- üîç Filtro y orden -->
  <form method="GET" class="filtro-fechas d-flex align-items-end gap-3 mb-4 flex-wrap">
    <div>
      <label for="fecha_inicio">Desde:</label>
      <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
    </div>
    <div>
      <label for="fecha_fin">Hasta:</label>
      <input type="date" name="fecha_fin" id="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
    </div>
    <button type="submit" class="btn-accion">
      <i class="fa-solid fa-filter"></i>
      <span>Filtrar</span>
    </button>
    <a
      href="?fecha_inicio={{ request.args.get('fecha_inicio', '') }}&fecha_fin={{ request.args.get('fecha_fin', '') }}&orden={% if request.args.get('orden') == 'asc' %}desc{% else %}asc{% endif %}"
      class="btn-accion text-decoration-none"
      title="Ordenar"
    >
      <i class="fa-solid {% if request.args.get('orden') == 'asc' %}fa-arrow-up-wide-short{% else %}fa-arrow-down-wide-short{% endif %}"></i>
      <span>Ordenar</span>
    </a>

    <!-- üéõ Filtros avanzados -->
    <div class="dropdown">
      <button class="btn-accion" type="button" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fa-solid fa-sliders"></i> Filtros
      </button>
      <div class="dropdown-menu p-3 shadow" style="min-width: 300px;">
        <input type="hidden" name="orden" value="{{ request.args.get('orden', 'desc') }}">
        <input type="hidden" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
        <input type="hidden" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">

        <!-- Centro -->
        <div class="mb-3">
          <label for="centro" class="form-label">
            <i class="fa-solid fa-filter me-1"></i>Centro
          </label>
          <select class="form-select" name="centro" id="centro">
            <option value="">Todos</option>
            {% for c in centros %}
              <option value="{{ c }}" {% if request.args.get('centro') == c %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>

        <!-- Programa -->
        <div class="mb-3">
          <label for="programa" class="form-label">
            <i class="fa-solid fa-filter me-1"></i>Programa
          </label>
          <select class="form-select" name="programa" id="programa">
            <option value="">Todos</option>
            {% for p in programas %}
              <option value="{{ p }}" {% if request.args.get('programa') == p %}selected{% endif %}>{{ p }}</option>
            {% endfor %}
          </select>
        </div>

        <button type="submit" class="btn btn-success w-100">Aplicar filtros</button>
      </div>
    </div>
  </form>

  <!-- üßæ Encabezado tipo Word -->
  <div class="encabezado-reportes fila-reporte">
    <span class="nombre-reporte">Nombre</span>
    <span class="instructor-reporte">Instructor</span>
    <span class="fecha-reporte">Fecha</span>
    <span></span>
  </div>

  <!-- üìÑ Lista de reportes -->
  {% for reporte in reportes %}
  <div class="fila-reporte fila-reporte-link" onclick="window.location.href='/Inforise/revision/{{ reporte[0] }}'">
    <div class="nombre-reporte d-flex align-items-center gap-2">
      <i class="fa-solid fa-file-lines text-success"></i>
      <span style="text-decoration: none; color: inherit;">
        {{ reporte[7] }}
      </span>
      {% if not reporte[9] %}
        <form method="POST" action="{{ url_for('marcar_revisado', id_reporte=reporte[0]) }}" onsubmit="event.stopPropagation();" class="ms-2">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <button type="submit" class="btn-accion" title="Marcar como revisado">
            <i class="fa-solid fa-check"></i>
            <span>Revisar</span>
          </button>
        </form>
      {% else %}
        <span class="badge bg-success ms-2">Revisado</span>
      {% endif %}
    </div>
    <div class="instructor-reporte">{{ reporte[8] }}</div>
    <div class="fecha-reporte">{{ reporte[2] }}</div>
    <div>
      <a href="{{ url_for('generar_pdf', id_reporte=reporte[0]) }}" class="btn btn-sm btn-descargar" title="Descargar" onclick="event.stopPropagation();">
        <i class="fa-solid fa-download"></i>
      </a>
    </div>
  </div>
  {% endfor %}
</div>
{% endblock %}