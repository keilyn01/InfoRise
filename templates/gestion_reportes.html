{% extends "base.html" %}
{% block titulo %}Gesti贸n de reportes{% endblock %}

{% block contenido %}
<div class="container contenedor-reportes">
  <h1 class="titulo-pagina mt-5">Gesti贸n de Reportes</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!--  Filtro y orden -->
  <form method="GET" class="filtro-fechas d-flex align-items-end gap-3 mb-4 flex-wrap">
    <div>
      <label for="fecha_inicio">Desde:</label>
      <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
    </div>
    <div>
      <label for="fecha_fin">Hasta:</label>
      <input type="date" name="fecha_fin" id="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
    </div>
    <button type="submit" class="btn-accion">
      <i class="fa-solid fa-filter"></i>
      <span>Filtrar</span>
    </button>
    <a
      href="?fecha_inicio={{ request.args.get('fecha_inicio', '') }}&fecha_fin={{ request.args.get('fecha_fin', '') }}&orden={% if request.args.get('orden') == 'asc' %}desc{% else %}asc{% endif %}"
      class="btn-accion text-decoration-none"
      title="Ordenar"
    >
      <i class="fa-solid {% if request.args.get('orden') == 'asc' %}fa-arrow-up-wide-short{% else %}fa-arrow-down-wide-short{% endif %}"></i>
      <span>Ordenar</span>
    </a>

    <!--  Bot贸n Filtros -->
    <div>
      <button type="button" class="btn-accion" onclick="document.getElementById('filtros-categorias').classList.toggle('d-none')">
        <i class="fa-solid fa-sliders"></i> Filtros
      </button>
    </div>
  </form>

  <!--  Filtros por categor铆a -->
  <div id="filtros-categorias" class="d-flex flex-wrap gap-2 mt-3 d-none">
    <!-- Centros -->
    <div class="dropdown">
      <button class="btn-accion dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fa-solid fa-building"></i> Centros
      </button>
      <div class="dropdown-menu dropdown-filtro p-3 shadow">
        <form method="GET" id="centroForm">
          <input type="hidden" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
          <input type="hidden" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
          <input type="hidden" name="orden" value="{{ request.args.get('orden', 'desc') }}">
          {% for p in request.args.getlist('programa') %}
            <input type="hidden" name="programa" value="{{ p }}">
          {% endfor %}

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="centro" value="" id="centroTodos"
                   {% if not request.args.getlist('centro') or '' in request.args.getlist('centro') %}checked{% endif %}
                   onchange="limpiarYEnviar('centroForm', 'centro')">
            <label class="form-check-label" for="centroTodos">Todos</label>
          </div>
          {% for c in centros %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="centro" value="{{ c }}" id="centro_{{ loop.index }}"
                   {% if c in request.args.getlist('centro') %}checked{% endif %}
                   onchange="desmarcarTodosYEnviar('centroForm', 'centroTodos')">
            <label class="form-check-label" for="centro_{{ loop.index }}">{{ c }}</label>
          </div>
          {% endfor %}
        </form>
      </div>
    </div>

    <!-- Programas -->
    <div class="dropdown">
      <button class="btn-accion dropdown-toggle" type="button" data-bs-toggle="dropdown">
        <i class="fa-solid fa-graduation-cap"></i> Programas
      </button>
      <div class="dropdown-menu dropdown-filtro p-3 shadow">
        <form method="GET" id="programaForm">
          <input type="hidden" name="fecha_inicio" value="{{ request.args.get('fecha_inicio', '') }}">
          <input type="hidden" name="fecha_fin" value="{{ request.args.get('fecha_fin', '') }}">
          <input type="hidden" name="orden" value="{{ request.args.get('orden', 'desc') }}">
          {% for c in request.args.getlist('centro') %}
            <input type="hidden" name="centro" value="{{ c }}">
          {% endfor %}

          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="programa" value="" id="programaTodos"
                   {% if not request.args.getlist('programa') or '' in request.args.getlist('programa') %}checked{% endif %}
                   onchange="limpiarYEnviar('programaForm', 'programa')">
            <label class="form-check-label" for="programaTodos">Todos</label>
          </div>
          {% for p in programas %}
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="programa" value="{{ p }}" id="programa_{{ loop.index }}"
                   {% if p in request.args.getlist('programa') %}checked{% endif %}
                   onchange="desmarcarTodosYEnviar('programaForm', 'programaTodos')">
            <label class="form-check-label" for="programa_{{ loop.index }}">{{ p }}</label>
          </div>
          {% endfor %}
        </form>
      </div>
    </div>
  </div>

  <!-- Ь Encabezado tipo Word -->
  <div class="encabezado-reportes fila-reporte">
    <span class="nombre-reporte">Nombre</span>
    <span class="instructor-reporte">Instructor</span>
    <span class="coordinador-revisiones">Coordinador</span>
    <span class="fecha-reporte">Fecha</span>
    <span class="centro-reporte">Centro</span>
    <span class="estado-reporte">Estado</span>
    <span class="descargar-reporte">Descargar</span>
  </div>

  <!--  Lista de reportes -->
  {% if reportes %}
    {% for reporte in reportes %}
    <div class="fila-reporte">
      <div class="nombre-reporte d-flex flex-column gap-1">
        <div class="d-flex align-items-center gap-2">
          <i class="fa-solid fa-file-lines text-success"></i>
          <span>{{ reporte[3] or 'Reporte sin nombre' }}</span>
        </div>
        {% if reporte[6] %}
          <span class="badge bg-primary">Revisado</span>
        {% endif %}
      </div>
      <div class="instructor-reporte">{{ reporte[4] }}</div>
      <div class="coordinador-revisiones">{{ reporte[5] }}</div>
      <div class="fecha-reporte">{{ reporte[2] }}</div>
      <div class="centro-reporte">{{ reporte[8] }}</div>
      <div class="estado-reporte">
        <span class="estado-texto">{{ 'Activo' if reporte[7] else 'Inactivo' }}</span>
      </div>
      <div class="descargar-reporte">
        <a href="{{ url_for('generar_pdf', id_reporte=reporte[0]) }}" class="btn btn-sm btn-descargar" title="Descargar">
          <i class="fa-solid fa-download"></i>
        </a>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="text-center mt-5">
      <p class="text-muted">Sin resultados para esta combinaci贸n de filtros.</p>
    </div>
  {% endif %}
</div>
<script>
  // Evita que los dropdowns de filtros se cierren al hacer clic dentro
  document.querySelectorAll('.dropdown-menu.dropdown-filtro').forEach(menu => {
    menu.addEventListener('click', function (e) {
      e.stopPropagation();
    });
  });

  function limpiarYEnviar(formId, campo) {
    const form = document.getElementById(formId);
    const checkboxes = form.querySelectorAll(`input[name="${campo}"]`);
    checkboxes.forEach(cb => {
      if (cb.value !== "") cb.checked = false;
    });
    form.submit();
  }

  function desmarcarTodosYEnviar(formId, todosId) {
    const todos = document.getElementById(todosId);
    if (todos) todos.checked = false;
    document.getElementById(formId).submit();
  }
</script>
{% endblock %}
